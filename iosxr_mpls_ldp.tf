resource "iosxr_mpls_ldp" "mpls_ldp" {
  for_each                                                 = { for device in local.devices : device.name => device if try(local.device_config[device.name].mpls_ldp, null) != null || try(local.defaults.iosxr.devices.configuration.mpls_ldp, null) != null }
  device                                                   = each.value.name
  router_id                                                = try(local.device_config[each.value.name].mpls_ldp.router_id, local.defaults.iosxr.devices.configuration.mpls_ldp.router_id, null)
  graceful_restart                                         = try(local.device_config[each.value.name].mpls_ldp.graceful_restart, local.defaults.iosxr.devices.configuration.mpls_ldp.graceful_restart, null)
  graceful_restart_reconnect_timeout                       = try(local.device_config[each.value.name].mpls_ldp.graceful_restart_reconnect_timeout, local.defaults.iosxr.devices.configuration.mpls_ldp.graceful_restart_reconnect_timeout, null)
  graceful_restart_forwarding_state_holdtime               = try(local.device_config[each.value.name].mpls_ldp.graceful_restart_forwarding_state_holdtime, local.defaults.iosxr.devices.configuration.mpls_ldp.graceful_restart_forwarding_state_holdtime, null)
  graceful_restart_helper_peer_maintain_on_local_reset_for = try(local.device_config[each.value.name].mpls_ldp.graceful_restart_helper_peer_maintain_on_local_reset_for, local.defaults.iosxr.devices.configuration.mpls_ldp.graceful_restart_helper_peer_maintain_on_local_reset_for, null)
  ltrace_buffer_multiplier                                 = try(local.device_config[each.value.name].mpls_ldp.ltrace_buffer_multiplier, local.defaults.iosxr.devices.configuration.mpls_ldp.ltrace_buffer_multiplier, null)
  default_vrf_implicit_ipv4_disable                        = try(local.device_config[each.value.name].mpls_ldp.default_vrf_implicit_ipv4_disable, local.defaults.iosxr.devices.configuration.mpls_ldp.default_vrf_implicit_ipv4_disable, null)
  session_backoff_time_initial                             = try(local.device_config[each.value.name].mpls_ldp.session_backoff_time_initial, local.defaults.iosxr.devices.configuration.mpls_ldp.session_backoff_time_initial, null)
  session_backoff_time_maximum                             = try(local.device_config[each.value.name].mpls_ldp.session_backoff_time_maximum, local.defaults.iosxr.devices.configuration.mpls_ldp.session_backoff_time_maximum, null)
  session_holdtime                                         = try(local.device_config[each.value.name].mpls_ldp.session_holdtime, local.defaults.iosxr.devices.configuration.mpls_ldp.session_holdtime, null)
  session_downstream_on_demand_with                        = try(local.device_config[each.value.name].mpls_ldp.session_downstream_on_demand_with, local.defaults.iosxr.devices.configuration.mpls_ldp.session_downstream_on_demand_with, null)
  session_protection                                       = try(local.device_config[each.value.name].mpls_ldp.session_protection, local.defaults.iosxr.devices.configuration.mpls_ldp.session_protection, null)
  session_protection_duration                              = try(local.device_config[each.value.name].mpls_ldp.session_protection_duration, local.defaults.iosxr.devices.configuration.mpls_ldp.session_protection_duration, null)
  session_protection_duration_infinite                     = try(local.device_config[each.value.name].mpls_ldp.session_protection_duration_infinite, local.defaults.iosxr.devices.configuration.mpls_ldp.session_protection_duration_infinite, null)
  session_protection_for_acl                               = try(local.device_config[each.value.name].mpls_ldp.session_protection_for_acl, local.defaults.iosxr.devices.configuration.mpls_ldp.session_protection_for_acl, null)
  session_protection_for_acl_duration                      = try(local.device_config[each.value.name].mpls_ldp.session_protection_for_acl_duration, local.defaults.iosxr.devices.configuration.mpls_ldp.session_protection_for_acl_duration, null)
  session_protection_for_acl_duration_infinite             = try(local.device_config[each.value.name].mpls_ldp.session_protection_for_acl_duration_infinite, local.defaults.iosxr.devices.configuration.mpls_ldp.session_protection_for_acl_duration_infinite, null)
  nsr                                                      = try(local.device_config[each.value.name].mpls_ldp.nsr, local.defaults.iosxr.devices.configuration.mpls_ldp.nsr, null)
  entropy_label                                            = try(local.device_config[each.value.name].mpls_ldp.entropy_label, local.defaults.iosxr.devices.configuration.mpls_ldp.entropy_label, null)
  entropy_label_add_el                                     = try(local.device_config[each.value.name].mpls_ldp.entropy_label_add_el, local.defaults.iosxr.devices.configuration.mpls_ldp.entropy_label_add_el, null)
  signalling_dscp                                          = try(local.device_config[each.value.name].mpls_ldp.signalling_dscp, local.defaults.iosxr.devices.configuration.mpls_ldp.signalling_dscp, null)
  igp_sync_delay_on_session_up                             = try(local.device_config[each.value.name].mpls_ldp.igp_sync_delay_on_session_up, local.defaults.iosxr.devices.configuration.mpls_ldp.igp_sync_delay_on_session_up, null)
  igp_sync_delay_on_proc_restart                           = try(local.device_config[each.value.name].mpls_ldp.igp_sync_delay_on_proc_restart, local.defaults.iosxr.devices.configuration.mpls_ldp.igp_sync_delay_on_proc_restart, null)
  capabilities_sac                                         = try(local.device_config[each.value.name].mpls_ldp.capabilities_sac, local.defaults.iosxr.devices.configuration.mpls_ldp.capabilities_sac, null)
  capabilities_sac_fec128_disable                          = try(local.device_config[each.value.name].mpls_ldp.capabilities_sac_fec128_disable, local.defaults.iosxr.devices.configuration.mpls_ldp.capabilities_sac_fec128_disable, null)
  capabilities_sac_fec129_disable                          = try(local.device_config[each.value.name].mpls_ldp.capabilities_sac_fec129_disable, local.defaults.iosxr.devices.configuration.mpls_ldp.capabilities_sac_fec129_disable, null)
  capabilities_sac_ipv4_disable                            = try(local.device_config[each.value.name].mpls_ldp.capabilities_sac_ipv4_disable, local.defaults.iosxr.devices.configuration.mpls_ldp.capabilities_sac_ipv4_disable, null)
  capabilities_sac_ipv6_disable                            = try(local.device_config[each.value.name].mpls_ldp.capabilities_sac_ipv6_disable, local.defaults.iosxr.devices.configuration.mpls_ldp.capabilities_sac_ipv6_disable, null)
  log_hello_adjacency                                      = try(local.device_config[each.value.name].mpls_ldp.log_hello_adjacency, local.defaults.iosxr.devices.configuration.mpls_ldp.log_hello_adjacency, null)
  log_neighbor                                             = try(local.device_config[each.value.name].mpls_ldp.log_neighbor, local.defaults.iosxr.devices.configuration.mpls_ldp.log_neighbor, null)
  log_nsr                                                  = try(local.device_config[each.value.name].mpls_ldp.log_nsr, local.defaults.iosxr.devices.configuration.mpls_ldp.log_nsr, null)
  log_graceful_restart                                     = try(local.device_config[each.value.name].mpls_ldp.log_graceful_restart, local.defaults.iosxr.devices.configuration.mpls_ldp.log_graceful_restart, null)
  log_session_protection                                   = try(local.device_config[each.value.name].mpls_ldp.log_session_protection, local.defaults.iosxr.devices.configuration.mpls_ldp.log_session_protection, null)
  discovery_hello_holdtime                                 = try(local.device_config[each.value.name].mpls_ldp.discovery_hello_holdtime, local.defaults.iosxr.devices.configuration.mpls_ldp.discovery_hello_holdtime, null)
  discovery_hello_interval                                 = try(local.device_config[each.value.name].mpls_ldp.discovery_hello_interval, local.defaults.iosxr.devices.configuration.mpls_ldp.discovery_hello_interval, null)
  discovery_targeted_hello_holdtime                        = try(local.device_config[each.value.name].mpls_ldp.discovery_targeted_hello_holdtime, local.defaults.iosxr.devices.configuration.mpls_ldp.discovery_targeted_hello_holdtime, null)
  discovery_targeted_hello_interval                        = try(local.device_config[each.value.name].mpls_ldp.discovery_targeted_hello_interval, local.defaults.iosxr.devices.configuration.mpls_ldp.discovery_targeted_hello_interval, null)
  discovery_instance_tlv_disable                           = try(local.device_config[each.value.name].mpls_ldp.discovery_instance_tlv_disable, local.defaults.iosxr.devices.configuration.mpls_ldp.discovery_instance_tlv_disable, null)
  discovery_ds_tlv_disable                                 = try(local.device_config[each.value.name].mpls_ldp.discovery_ds_tlv_disable, local.defaults.iosxr.devices.configuration.mpls_ldp.discovery_ds_tlv_disable, null)
  discovery_rtr_id_arb_tlv_disable                         = try(local.device_config[each.value.name].mpls_ldp.discovery_rtr_id_arb_tlv_disable, local.defaults.iosxr.devices.configuration.mpls_ldp.discovery_rtr_id_arb_tlv_disable, null)
  discovery_quick_start_disable                            = try(local.device_config[each.value.name].mpls_ldp.discovery_quick_start_disable, local.defaults.iosxr.devices.configuration.mpls_ldp.discovery_quick_start_disable, null)
  neighbor_dual_stack_transport_connection_prefer_ipv4     = try(local.device_config[each.value.name].mpls_ldp.neighbor_dual_stack_transport_connection_prefer_ipv4, local.defaults.iosxr.devices.configuration.mpls_ldp.neighbor_dual_stack_transport_connection_prefer_ipv4, null)
  neighbor_dual_stack_transport_connection_max_wait        = try(local.device_config[each.value.name].mpls_ldp.neighbor_dual_stack_transport_connection_max_wait, local.defaults.iosxr.devices.configuration.mpls_ldp.neighbor_dual_stack_transport_connection_max_wait, null)
  neighbor_dual_stack_tlv_compliance                       = try(local.device_config[each.value.name].mpls_ldp.neighbor_dual_stack_tlv_compliance, local.defaults.iosxr.devices.configuration.mpls_ldp.neighbor_dual_stack_tlv_compliance, null)
  neighbors = try(length(local.device_config[each.value.name].mpls_ldp.neighbors) == 0, true) ? null : [for neighbor in local.device_config[each.value.name].mpls_ldp.neighbors : {
    neighbor_address   = try(neighbor.neighbor_address, null)
    label_space_id     = try(neighbor.label_space_id, null)
    password_disable   = try(neighbor.password_disable, null)
    password_encrypted = try(neighbor.password_encrypted, null)
  }]
}
